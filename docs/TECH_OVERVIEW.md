# Технический обзор AgroCalculator PPR

## Архитектура
- **UI**: React Native + React Navigation, функциональные компоненты.
- **Слои**:
  - *screens* — экраны, отвечающие за ввод/отображение.
  - *components* — переиспользуемые UI-блоки.
  - *services* — бизнес-логика (подбор, расчёты, аналитика, предупреждения, отчёты, кэширование).
  - *repositories* — доступ к SQLite (через `Database` + `react-native-sqlite-storage`).
  - *data* — seed-данные, справочники BBCH, регламенты.
  - *utils* — вспомогательные функции (валидация, форматирование, кэш).

## Хранение данных
- SQLite с 12 таблицами (`crops`, `pests`, `products`, `treatments`, `treatment_products`, `warehouse_inventory`, `treatment_plans`, `resistance_records`, `user_settings` и др.).
- Индексы для ускорения (`products.type`, `treatments.treatment_date`, `resistance_records.field_id` и т.д.).
- Сервис `DatabaseService` инициализирует БД, запускает сидеры (`SeedService`, `SeedEfficacyService`).

## Бизнес-логика
- **ProductSelectionService** — объединяет эффективность, совместимость и условия; использует bulk-запросы и кэш эффективности по продукту.
- **CalculationService** — коэффициенты почвы/температуры/влажности, расчёт раствора и стоимости.
- **TankMixService** — проверка совместимости (хим., физ., био), очередь смешивания, предупреждения.
- **AnalyticsService** — экономические показатели, кеширование (TTL 5 мин), bulk-запрос средних эффективностей.
- **AgronomicAnalyticsService** — эффективность против вредителей, сезонная динамика, кеширование.
- **WarningService** — агрегация рисков (резистентность, фитотоксичность, склад, погода).
- **OfflineService** — экспорт/импорт JSON с валидацией и восстановлением связей.
- **SettingsService** — единицы, язык, значения по умолчанию, уведомления.
- **ReportService** — CSV-отчёты (обработки, аналитика, план, склад) и пакетная генерация.

## Производительность
- Кэширование (`TimedCache`) для экономической и агрономической аналитики.
- Bulk-запросы (`getAverageEfficacyBulk`, `getPestEfficacyForProduct`) вместо множественных последовательных вызовов.
- Предварительная фильтрация и одногоразовая загрузка данных в подборе препаратов и поиске.
- Индексы и ленивые пересчёты (репозитории возвращают только необходимые поля).

## Тестирование
- **CalculationService** — unit-тесты (коэффициенты, дозы, стоимость).
- **ProductSelectionService** — мок-репозитории, проверка ранжирования и предупреждений.
- **TankMixService** — выявление несовместимости, порядок смешивания, предупреждения.
- **TreatmentRepository** — мок SQLite, проверка включения продуктов.
- Jest (`npm test`) с пресетом React Native.

## Экспорт и резервное копирование
- JSON (полная база + настройки) через «Настройки».
- CSV-отчёты формируются на отдельном экране с возможностью поделиться результатом.

## Настройки
- Таблица `user_settings`, сервис `SettingsService`, экран управления настройками и резервным копированием.

## Дальнейшие шаги
- Расширение тестового покрытия (ProductSelectionService, TankMixService — дополнительные сценарии, репозитории).
- Дополнительная оптимизация (кэш WarningService/SearchService, анализ горячих запросов).
- Поддержка форматов PDF/Excel и шаблонов печати.
- Подготовка расширенной документации API.
